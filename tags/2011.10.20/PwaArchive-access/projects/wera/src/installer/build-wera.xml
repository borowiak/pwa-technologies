<?xml version="1.0"?>
<!-- $Id: build-wera.xml 842 2006-03-17 11:46:07Z sverreb $ -->
<project name="Create WERA Installer Zip Build" default="selfextract" basedir=".">

  <taskdef resource="net/sf/antcontrib/antcontrib.properties"/>

  <target name="selfextract" depends="">
    <echo message="Starting the Wera installer build ... "/>
    <input message="Please enter sourceforge-username, hit enter for default [sverreb]:" addproperty="nwa.sfuser" defaultvalue="sverreb"/>
    <input message="Please enter CVS-TAG to build from. Note! The tag has to exist. Hit enter for default [head]:" addproperty="wera.cvstag" defaultvalue="head"/>
    <input message="Please enter release number to name this build. Leave empty to use date or tag in build name:" addproperty="wera.relno" defaultvalue=""/>
    <echo message="CVS-user: ${nwa.sfuser}"/>
        
    <!-- Properties for CVS  -->
    <property name="cvsexport" location="${basedir}/cvsexport"/>
    <delete dir="${cvsexport}"/>
    <mkdir dir="${cvsexport}"/>

    <!-- Properties for generating documentation  -->
    <property name="releasenotes.xml" value="${cvsexport}/archive-access/projects/wera/src/articles/releasenotes.xml"/>
    <property name="releasenotes.html" value="${cvsexport}/articles/releasenotes.html"/>
    
    <property name="input.file" value="${cvsexport}/archive-access/projects/wera/src/articles/manual.xml"/>
    <property name="output.html" value="${cvsexport}/articles/manual.html"/>
    <property name="output.pdf" value="${cvsexport}/articles/manual.pdf"/>
    <property name="docbook.dir" value="/usr/share/xml/docbook" />
    <property name="saxon.dir" value="/usr/share/saxon" />
    <property name="fop.dir" value="/usr/share/fop/build" />
    <property name="jimi.dir" value="/usr/share/fop/lib" />

    <echo message="Fetching source code ... "/>
  
    <if>
      <equals arg1="${wera.relno}" arg2="" />
      <then>
        <tstamp>
          <format property="weraversion" pattern="yyyyMMddHHmm"/>
        </tstamp>
      </then>
      <else>
        <property name="weraversion" value="${wera.relno}"/>
      </else>
    </if>
    
    <if>
      <equals arg1="${wera.cvstag}" arg2="head" />
      <then>
        <property name="werapack" value="wera-${weraversion}"/>	    
        <echo message="Package name: ${werapack}"/>
        <echo message="Retrieving most recent files from cvs"/>
		<cvs command="export"
		     cvsRoot=":ext:${nwa.sfuser}@cvs.sourceforge.net:/cvsroot/archive-access" 
		     package="archive-access/projects/wera/src archive-access/projects/wera/lib" 
		     date="tomorrow" 
		     dest="${cvsexport}"
		     failonerror="true"/>
      </then>
      <else>
        <echo message="Retrieving files with tag ${wera.cvstag} from cvs"/>
        <cvs command="export" 
		     cvsRoot=":ext:${nwa.sfuser}@cvs.sourceforge.net:/cvsroot/archive-access" 
		     package="archive-access/projects/wera/src archive-access/projects/wera/lib" 
		     tag="${wera.cvstag}" 
		     dest="${cvsexport}" 
		     failonerror="true"/>
        <property name="werapack" value="${wera.cvstag}"/>
        <property name="weraversion" value="${wera.cvstag}"/>
        <echo message="Package name: ${werapack}"/>
      </else>
    </if>

    <delete file="${cvsexport}/archive-access/projects/wera/src/webapps/wera/lib/config.inc"/>

   <echo message="Generating documentation"/>
    <mkdir dir="${cvsexport}/articles"/>

    <copy todir="${cvsexport}/articles">
      <fileset dir="${cvsexport}/archive-access/projects/wera/src/articles">
        <include name="images/*"/>
      </fileset>
    </copy>


    <path id="fop.classpath">
      <fileset dir="${fop.dir}">
        <include name="**/*.jar"/>
      </fileset>
      <fileset dir="${jimi.dir}">
        <include name="**/*.jar"/>
      </fileset>
    </path>
    <echo message="Creating manual.html"/>
    <java jar="${saxon.dir}/saxon.jar" fork="true" output="${output.html}">
      <arg value="${input.file}"/>
      <arg value="${docbook.dir}/stylesheet/nwalsh/current/html/docbook.xsl"/>
    </java>
    <echo message="Creating releasenotes.html"/>
    <java jar="${saxon.dir}/saxon.jar" fork="true" output="${releasenotes.html}">
      <arg value="${releasenotes.xml}"/>
      <arg value="${docbook.dir}/stylesheet/nwalsh/current/html/docbook.xsl"/>
    </java>
    <echo message="Creating manual.pdf"/>
    <java classname="org.apache.fop.apps.Fop" fork="true">
      <classpath refid="fop.classpath"/>
      <arg line="-xml ${input.file}"/>
      <arg line="-xsl ${docbook.dir}/stylesheet/nwalsh/current/fo/docbook.xsl"/>
      <arg value="${output.pdf}"/>
    </java>

     <delete dir="arcretriever"/>
     
   <echo message="Building ARC Retriever"/>
    <ant antfile="build-retriever.xml"/>

    <replace file="${cvsexport}/archive-access/projects/wera/src/webapps/wera/lib/header.inc">
      <replacefilter token="@VERSION@" value="${weraversion}"/>
    </replace>

    <zip file="./wera.zip">
      <zipfileset dir="${cvsexport}">
        <include name="articles/**/*"/>
        <include name="**/releasenotes.html"/>
      </zipfileset>
      <zipfileset dir="${cvsexport}/archive-access/projects/wera/src/webapps/wera">
        <include name="**/*"/>
      </zipfileset>
      <zipfileset dir=".">
        <include name="arcretriever/**/*"/>
      </zipfileset>
    </zip>

<!--    <echo message="Building manual install package"/>    
    <property name="manualinstalldir" location="${basedir}/manual-install"/>
    <delete dir="${manualinstalldir}"/>
    <mkdir dir="${manualinstalldir}"/>

    <mkdir dir="${manualinstalldir}"/>
    <copy todir="${manualinstalldir}/wera">
      <fileset dir="${cvsexport}/wera/gui"/>
    </copy>

    <mkdir dir="${manualinstalldir}/wera/manual"/>
    <mkdir dir="${manualinstalldir}/wera/manual/images"/>
    <copy file="${cvsexport}/manual/manual.html" tofile="${manualinstalldir}/wera/manual/manual.html"/>
    <copy file="${cvsexport}/manual/manual.pdf" tofile="${manualinstalldir}/wera/manual/manual.pdf"/>
    <copy file="${cvsexport}/manual/RELEASE-NOTES" tofile="${manualinstalldir}/wera/RELEASE-NOTES"/>
    <copy todir="${manualinstalldir}/wera/manual/images">
      <fileset dir="${cvsexport}/manual/images"/>
    </copy>

    <copy file="${cvsexport}/wera/gui/lib/config.inc.template" tofile="${manualinstalldir}/wera/lib/config.inc"/>
    <replace file="${manualinstalldir}/wera/lib/config.inc">
      <replacefilter token="@aidPrefix@" value="/var/arcs"/>
      <replacefilter token="@aidSuffix@" value=".arc.gz"/>
      <replacefilter token="@guiInstallDir@" value="/opt/lampp/htdocs/wera"/>
      <replacefilter token="@hostName@" value="localhost"/>
      <replacefilter token="@retrieverUrl@" value="http://localhost:8080/ArcRetriever/ArcRetriever"/>
      <replacefilter token="@guiUrl@" value="http://localhost/wera"/>
      <replacefilter token="@collection@" value="test"/>
      <replacefilter token="@searchEngine@" value="nutch"/>
      <replacefilter token="@searchEngineUrl@" value="http://localhost:8080/nutchwax/opensearch"/>
    </replace>

    <copy file="${cvsexport}/retriever/arcretriever/ArcRetriever.war" tofile="${manualinstalldir}/wera/ArcRetriever.war"/>
    
	<tar tarfile="${werapack}-manual-install.tar" basedir="${manualinstalldir}"/>
	<gzip zipfile="${werapack}-manual-install.tar.gz" src="${werapack}-manual-install.tar"/>
    <delete file="${werapack}-manual-install.tar"/>   --> 
    
    <echo message="Building Installer package"/>
        
    <mkdir dir="./selfextract"/>
    <unjar dest="./selfextract">
      <fileset dir="installlib">
        <include name="*.jar"></include>
      </fileset>
    </unjar>
    <copy todir="./selfextract">
      <fileset dir="installclasspath">
        <include name="resources/*"/>
      </fileset>
    </copy>
    <copy todir="./selfextract">
      <fileset dir=".">
        <include name="build.xml"/>
        <include name="antinstall-config.xml"/>
        <include name="wera.zip"/>
      </fileset>
    </copy>
    
    <delete file="wera.zip"/>        
    
    <copy todir="./selfextract">
      <fileset dir="${cvsexport}/archive-access/projects/wera/src/installer">
        <include name="install_info.txt"/>
      </fileset>
    </copy>
    <copy todir="./selfextract">
      <fileset dir="${cvsexport}/archive-access/projects/wera/src/articles/images">
        <include name="iipc.png"/>
      </fileset>
    </copy>
    <jar file="./${werapack}-installer.jar" compress="false">
      <manifest>
        <attribute name="Manifest-Version" value="1.0"/>
        <attribute name="Main-Class" value="org.tp23.antinstaller.selfextract.SelfExtractor"/>
        <attribute name="Look-And-Feel" value="org.tp23.jgoodies.plaf.plastic.PlasticXPLookAndFeel"/>
      </manifest>
      <fileset dir="selfextract">
        <include name="**/*"/>
      </fileset>
    </jar>
  </target>

</project>
